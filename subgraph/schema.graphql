# DeLong Protocol Subgraph Schema
# 设计原则：只存储原始事件数据，不做聚合计算
# 聚合计算由后端的聚合计算服务完成

# ========== Core Entities (基础实体) ==========

"""
Dataset - 数据集基本信息
"""
type Dataset @entity(immutable: false) {
  id: ID! # datasetId (uint256 as string)
  datasetId: BigInt!
  projectAddress: Bytes!

  # Contract addresses
  idoAddress: Bytes!
  tokenAddress: Bytes!
  managerAddress: Bytes!
  poolAddress: Bytes!

  createdAt: BigInt!
  createdAtBlock: BigInt!
  transactionHash: Bytes!
}

"""
IDOState - IDO合约的状态快照
"""
type IDOState @entity(immutable: false) {
  id: ID! # IDO address
  datasetId: String!
  status: String! # "Active", "Launched", "Failed"

  # 最后更新时间
  lastUpdatedAt: BigInt!
  lastUpdatedBlock: BigInt!
}

# ========== Raw Event Entities (原始事件实体) ==========

"""
TokenPurchaseEvent - 代币购买事件
"""
type TokenPurchaseEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  idoAddress: Bytes!

  buyer: Bytes!
  tokenAmount: BigInt!
  usdcCost: BigInt!
  fee: BigInt!
  newPrice: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
TokenSaleEvent - 代币出售事件
"""
type TokenSaleEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  idoAddress: Bytes!

  seller: Bytes!
  tokenAmount: BigInt!
  usdcRefund: BigInt!
  fee: BigInt!
  newPrice: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
IDOLaunchedEvent - IDO启动事件
"""
type IDOLaunchedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  idoAddress: Bytes!

  finalPrice: BigInt!
  totalRaised: BigInt!
  lpUSDC: BigInt!
  projectFunding: BigInt!
  lpTokensLocked: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
IDOFailedEvent - IDO失败事件
"""
type IDOFailedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  idoAddress: Bytes!

  soldTokens: BigInt!
  usdcBalance: BigInt!
  refundRate: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
RefundClaimedEvent - 退款领取事件
"""
type RefundClaimedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  idoAddress: Bytes!

  user: Bytes!
  tokenAmount: BigInt!
  usdcAmount: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
AccessPurchasedEvent - 租赁购买事件
"""
type AccessPurchasedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  tokenAddress: Bytes!

  user: Bytes!
  hours: BigInt!
  totalCost: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
UsageRecordedEvent - 使用记录事件
"""
type UsageRecordedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  tokenAddress: Bytes!

  user: Bytes!
  rentalIndex: BigInt!
  additionalMinutes: BigInt!
  totalUsedMinutes: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
RentalDistributedEvent - 租金分配事件
"""
type RentalDistributedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  tokenAddress: Bytes!

  totalAmount: BigInt!
  protocolFee: BigInt!
  dividend: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
RevenueAccumulatedEvent - 收入累积事件 (用于LP解锁)
"""
type RevenueAccumulatedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  tokenAddress: Bytes!

  additionalRevenue: BigInt!
  totalRevenue: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
LPLockedEvent - LP锁定事件
"""
type LPLockedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  tokenAddress: Bytes!

  lpToken: Bytes!
  projectAddress: Bytes!
  amount: BigInt!
  lpValueUSDC: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
LPWithdrawnEvent - LP提取事件
"""
type LPWithdrawnEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  tokenAddress: Bytes!

  amount: BigInt!
  accumulatedRevenue: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
DividendClaimedEvent - 分红领取事件
"""
type DividendClaimedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  poolAddress: Bytes!

  user: Bytes!
  amount: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
RevenueAddedEvent - 收益添加到池事件
"""
type RevenueAddedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  poolAddress: Bytes!

  amount: BigInt!
  accRevenuePerToken: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
TokenTransferEvent - 代币转账事件
"""
type TokenTransferEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  tokenAddress: Bytes!

  from: Bytes!
  to: Bytes!
  amount: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
TokenUnfrozenEvent - 代币解冻事件
"""
type TokenUnfrozenEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  tokenAddress: Bytes!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
MetadataUpdatedEvent - 元数据更新事件
"""
type MetadataUpdatedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  managerAddress: Bytes!

  oldURI: String!
  newURI: String!
  version: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
TrialUsageRecordedEvent - 试用记录事件
"""
type TrialUsageRecordedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  managerAddress: Bytes!

  user: Bytes!
  usedSeconds: BigInt!
  totalUsed: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
DatasetStatusUpdatedEvent - 数据集状态更新事件
"""
type DatasetStatusUpdatedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  datasetId: String!
  managerAddress: Bytes!

  oldStatus: Int!
  newStatus: Int!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

# ========== DAO Events ==========

"""
TreasuryProposalSubmittedEvent - 财务提案提交事件
"""
type TreasuryProposalSubmittedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  proposalId: BigInt!

  proposer: Bytes!
  recipient: Bytes!
  amount: BigInt!
  description: String!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
TreasuryProposalStatusEvent - 财务提案状态变更事件
"""
type TreasuryProposalStatusEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  proposalId: BigInt!

  status: String! # "Approved", "Rejected", "Executed", "Cancelled"

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
GovernanceProposalCreatedEvent - 治理提案创建事件
"""
type GovernanceProposalCreatedEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  proposalId: BigInt!

  proposer: Bytes!
  proposalType: Int! # 0=UpdatePrice, 1=UpdateManager, 2=Other
  targetContract: Bytes!
  description: String!
  newPrice: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
VoteCastEvent - 投票事件
"""
type VoteCastEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  proposalId: BigInt!

  voter: Bytes!
  choice: Int! # 0=Against, 1=For, 2=Abstain
  weight: BigInt!

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

"""
GovernanceProposalStatusEvent - 治理提案状态变更事件
"""
type GovernanceProposalStatusEvent @entity(immutable: true) {
  id: ID! # tx hash + log index
  proposalId: BigInt!

  status: String! # "Executed", "Cancelled"

  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}
